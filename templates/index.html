<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Chatbot</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .icon-container {
      position: fixed;
      bottom: 0;
      width: 100%;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }

    .query-icon {
      margin: 10px;
      padding: 10px;
      border-radius: 50%;
      background: #f8f8f8;
      border: 2px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 50px;
      min-height: 50px;
      cursor: pointer;
    }

    .query-icon.completed {
      border-color: green;
    }

    .query-icon.pending {
      border-color: orange;
    }
  </style>
</head>

<body>
  <div id="chat-area"></div>
  <form id="chat-form">
    <input type="text" name="message" id="chat-input">
    <button type="submit">Send</button>
  </form>
  <div id="icon-container" class="icon-container"></div> <!-- Icon Container -->
  <script>
    $(function () {
      const $chatArea = $('#chat-area');
      const $chatForm = $('#chat-form');
      const $chatInput = $('#chat-input');
      const $iconContainer = $('#icon-container'); // Icon Container

      $chatForm.submit(function (event) {
        event.preventDefault();
        const message = $chatInput.val();
        $chatInput.val('');
        $.ajax({
          type: 'POST',
          url: '/api/messages',
          contentType: 'application/json',
          data: JSON.stringify({ message }),
          success: function (response) {
            $chatArea.append(`<p>You: ${message}</p>`);
            $chatArea.append(`<p id="${response.id}">Bot: ${response.message}${response.message.includes('persistent') ? ' <span class="status">Checking status...</span>' : ''}</p>`);  // Add a span element with a class for persistent messages

            if (response.message.includes('persistent')) {
              // Add an icon for the query
              const icon = `<div id="icon-${response.id}" class="query-icon pending">${response.id}</div>`;
              $iconContainer.append(icon);
            }

            if (response.svg) {
              // Create a temporary div to hold the SVG
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = response.svg;

              // Extract the SVG from the div
              const svgElement = tempDiv.querySelector('svg');

              // Append the SVG element to the chat area
              $chatArea.append(svgElement);
            }
            if (response.csv) {
              var data = JSON.parse(response.csv);
              var table = $('<table></table>');
              var headers = Object.keys(data[0]);
              var headerRow = $('<tr></tr>');
              headers.forEach(function(header) {
                  headerRow.append($('<th></th>').text(header));
              });
              table.append(headerRow);
              data.forEach(function(rowData) {
                  var row = $('<tr></tr>');
                  headers.forEach(function(header) {
                      row.append($('<td></td>').text(rowData[header]));
                  });
                  table.append(row);
              });
              $chatArea.append(table);
            }

          },
          error: function (error) {
            console.log(error);
          }
        });
      });

      // Periodically check the endpoint for completed queries
      setInterval(function () {
        $.ajax({
          type: 'GET',
          url: '/api/query_status',
          success: function (response) {
            for (let i in response.pending) {
              createIcon(response.pending[i])
            }
            for (let query in response.completed) {
              //
            }
          },
          error: function (error) {
            console.log(error);
          }
        });
      }, 10000);  // Check every 10 seconds


    });
    function addIcons() {
      // Add a new button
      const addIconButton = document.createElement('button');
      addIconButton.textContent = 'Add Icon';
      //addIconButton.addEventListener('click', createIcon);

      // Add a new button
      const removeIconButton = document.createElement('button');
      removeIconButton.textContent = 'Remove Icons';
      removeIconButton.addEventListener('click', removeAllIcons);

      // Add the buttons to the chat area
      document.getElementById('chat-area').appendChild(addIconButton);
      document.getElementById('chat-area').appendChild(removeIconButton);
    }

    function createIcon(query) {
      // Check if the icon already exists
      const existingIcon = document.getElementById(`icon-${query}`);
      if (existingIcon) {
        // The icon already exists, do nothing
        return;
      }

      // The icon does not exist, create it
      const icon = document.createElement('div');
      icon.className = 'query-icon pending';
      icon.textContent = query;
      icon.id = `icon-${query}`;
      // Add the icon to the icon container
      document.getElementById('icon-container').appendChild(icon);
    }

    function removeIcon() {
      // Remove the icon from the icon container
      document.getElementById('icon-container').removeChild(document.getElementById('icon-container').lastChild);
    }

    function removeAllIcons() {
      // Remove all icons from the icon container
      while (document.getElementById('icon-container').firstChild) {
        document.getElementById('icon-container').removeChild(document.getElementById('icon-container').firstChild);
      }
    }


    // Call the function after the DOM has loaded
    window.addEventListener('DOMContentLoaded', addIcons);
  </script>
</body>

</html>